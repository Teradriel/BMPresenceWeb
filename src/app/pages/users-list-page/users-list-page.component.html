<div class="users-list-container">
  <div class="page-header">
    <h1>Gestione Utenti</h1>
    <button
      class="refresh-button"
      (click)="loadUsers()"
      [disabled]="isBusy"
      title="Aggiorna lista utenti"
    >
      <span class="refresh-icon">üîÑ</span>
      Aggiorna
    </button>
  </div>

  <!-- Error message -->
  @if (errorMessage) {
    <div class="error-message">
      {{ errorMessage }}
    </div>
  }

  <!-- Loading indicator -->
  @if (isBusy) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Caricamento in corso...</p>
    </div>
  }

  <!-- Users table -->
  @if (!isBusy && users.length > 0) {
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Cognome</th>
            <th>Ruolo</th>
            <th>Data Registrazione</th>
            <th>Ultima Attivit√†</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
            <tr>
              <td>{{ user.name }}</td>
              <td>{{ user.lastName }}</td>
              <td>
                <span class="role-badge" [class.admin]="user.isAdmin">
                  {{ getUserRole(user.isAdmin) }}
                </span>
              </td>
              <td>{{ formatDate(user.createdAt) }}</td>
              <td>{{ formatDate(user.lastActiveAt) }}</td>
              <td>
                <button
                  class="reset-button"
                  (click)="openResetPasswordDialog(user)"
                  [disabled]="isBusy"
                  title="Resetta password"
                >
                  üîë Resetta Password
                </button>
                <button
                  class="delete-button"
                  (click)="deleteUser(user)"
                  [disabled]="isBusy"
                  title="Elimina utente"
                >
                  üóëÔ∏è Elimina
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Empty state -->
  @if (!isBusy && users.length === 0 && !errorMessage) {
    <div class="empty-state">
      <p>Nessun utente trovato.</p>
    </div>
  }

  <!-- Reset Password Dialog -->
  @if (showResetDialog && selectedUser) {
    <div class="modal-overlay" (click)="closeResetDialog()">
      <div class="modal-dialog" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Resetta Password</h2>
          <button
            class="close-button"
            (click)="closeResetDialog()"
            [disabled]="isBusy"
          >
            √ó
          </button>
        </div>

        <div class="modal-body">
          <p class="user-info">
            Resetta la password per:
            <strong>{{ selectedUser.name }} {{ selectedUser.lastName }}</strong>
          </p>

          <div class="form-group">
            <label for="newPassword">Nuova Password Temporale:</label>
            <input
              id="newPassword"
              type="password"
              class="input-field"
              placeholder="Nuova password (min 6 caratteri)"
              [(ngModel)]="newPassword"
              [disabled]="isBusy"
              (keyup.enter)="executeResetPassword()"
              autofocus
            />
          </div>

          <div class="warning-message">
            ‚ö†Ô∏è L'utente dovr√† cambiare questa password al prossimo accesso.
          </div>

          @if (resetErrorMessage) {
            <div class="error-message">
              {{ resetErrorMessage }}
            </div>
          }
        </div>

        <div class="modal-footer">
          <button
            class="confirm-button"
            (click)="executeResetPassword()"
            [disabled]="isBusy || !newPassword"
          >
            {{ isBusy ? "Resettando..." : "Resetta Password" }}
          </button>
          <button
            class="cancel-button"
            (click)="closeResetDialog()"
            [disabled]="isBusy"
          >
            Annulla
          </button>
        </div>

        @if (isBusy) {
          <div class="loading-indicator">
            <div class="spinner"></div>
          </div>
        }
      </div>
    </div>
  }
</div>
